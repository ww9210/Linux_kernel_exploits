from angr import concretization_strategies
import angr


class InstrumentationMixin:
    def enable_custom_concretize(self, state):
        """
        obsolete
        :param state:
        :return:
        """
        print('[+] switching current concretization_strategy to Kuafffp...')
        state.inspect.address_concretization_strategy = self.kuafffp_concretizer
        raw_input()
        return

    def add_concretization_strategy(self, state, name_concretization_strategy):
        if name_concretization_strategy == 'kuafffp':
            print 'using kuafffp concretization'
            state.memory.read_strategies.insert(
                0, concretization_strategies.SimConcretizationStrategyKuafffp(mapped_addr=
                                                                              self.userspace_base,
                                                                              length=4096,
                                                                              limit=1))
        elif name_concretization_strategy == 'kuafffp2':  # more conservative concretization strategy
            print 'using kuafffp2 concretization2'
            state.memory.read_strategies.insert(
                0, concretization_strategies.SimConcretizationStrategyKuafffp2(mapped_addr=
                                                                               self.userspace_base,
                                                                               length=4096*self.num_user_pages,
                                                                               limit=1,
                                                                               step=0x100
                                                                               )
            )
        elif name_concretization_strategy == 'kuafffp3':  # more conservative concretization strategy
            print 'using kuafffp3 concretization3'
            state.memory.read_strategies.insert(0, angr.concretization_strategies.mycontrolled_data.MySimConcretizationStrategyControlledData(\
                    1, [self.uaf_object_base]))
        return

    def add_instrumentation(self, s):
        if len(self.extra_bp) > 0:  # TODO such bp is really bad
            for bp in self.extra_bp:
                s.inspect.b('instruction', when=angr.BP_BEFORE
                            , instruction=bp
                            , action=self.track_bp)
        s.inspect.b('mem_read', when=angr.BP_BEFORE, action=self.track_reads)
        s.inspect.b('mem_write', when=angr.BP_BEFORE, action=self.track_writes)
        s.inspect.b('call', when=angr.BP_BEFORE, action=self.track_call)
        s.inspect.b('symbolic_variable', when=angr.BP_AFTER, action=self.track_symbolic_variable)
        #s.inspect.b('address_concretization', when=angr.BP_BEFORE, action=self.address_concretization_before)
        #s.inspect.b('address_concretization', when=angr.BP_AFTER, action=self.address_concretization_after)
